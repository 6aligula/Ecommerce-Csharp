@model E_Commerce_App.WebUI.ViewModels.ProductViewModel
@if (ViewData["ProductId"].ToString() != "")
{
    ViewData["CurrentPage"] = "Ürünler / Düzenle / " + ViewData["ProductId"];
    ViewData["CurrentPageUrl"] = "Product/Edit/" + ViewData["ProductId"];
}
else
{
    ViewData["CurrentPage"] = "Ürünler / Ürün Ekle";
    ViewData["CurrentPageUrl"] = "Product/Edit/" + ViewData["ProductId"];
}

@section Css{
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Trumbowyg/2.23.0/ui/trumbowyg.min.css" integrity="sha512-iw/TO6rC/bRmSOiXlanoUCVdNrnJBCOufp2s3vhTPyP1Z0CtTSBNbEd5wIo8VJanpONGJSyPOZ5ZRjZ/ojmc7g==" crossorigin="anonymous" />

    <link href="~/node_modules/trumbowyg/dist/ui/trumbowyg.css" />
    <link href="~/node_modules/trumbowyg/dist/ui/trumbowyg.min.css" />
}


<form enctype="multipart/form-data" id="productForm" method="post">

    <input type="hidden" asp-for="Product.Id" />

    <input type="hidden" asp-for="Product.CreationDate" />

    <input type="hidden" asp-for="Product.MainImage" />

    <div class="row">
        <div class="col-md-8">
            <div class="card p-2">
                <div class="form-row">
                    <div class="col-md-6">
                        <input type="text" class="form-control" asp-for="Product.Name" placeholder="Ürün Adı" />
                        <span class="text-danger" asp-validation-for="Product.Name"></span>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" asp-for="Product.Url" placeholder="Ürün URL" />
                        <span class="text-danger" asp-validation-for="Product.Url"></span>
                    </div>
                </div>
                <br />
                <div class="form-row">
                    <div class="col-md-6">
                        <input type="number" step="0.1" min="1" max="1000000" class="form-control" asp-for="Product.Price" placeholder="Ürün Fiyatı" />
                        <span class="text-danger" asp-validation-for="Product.Price"></span>
                    </div>
                    <div class="col-md-6">
                        <input type="number" step="0.1" min="1" max="100" class="form-control" asp-for="Product.Discount" placeholder="İndirim %" />
                    </div>
                </div>
                <br />
                <textarea asp-for="Product.ShortDescription" maxlength="240" class="form-control" placeholder="Ön açıklama yazınızı buraya giriniz."></textarea>
                <br />
                <textarea id="html-editor" asp-for="Product.Description">
                    Ürünün Detaylı Açıklamasını Burada Yapınız
                </textarea>
                <span class="text-danger" asp-validation-for="Product.ShortDescription"></span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-2">
                <label>Kategoriler</label>
                <div class="bg-gradient-secondary p-2" style="border-radius:10px;">
                    @foreach (var category in Model.Categories)
                    {
                        <div class="form-check form-check-inline">
                            <input type="checkbox" class="form-check-input" value="@category.Id" name="categoryIds"
                                   id="category_@(category.Id)"
                                   @if (Model.SelectedCategories != null) { @(Model.SelectedCategories.Any(i => i.CategoryId == category.Id) ? "checked" : "") ; } />
                            <label class="form-check-label" for="category_@(category.Id)">@category.Name</label>
                        </div>
                    }
                </div>
                <hr />
                <label>Renkler</label>
                <div class="bg-gradient-secondary p-2" style="border-radius:10px;">
                    @foreach (var color in Model.Colors)
                    {
                        <div class="form-check form-check-inline">
                            <input type="checkbox" class="form-check-input" value="@color.Id" name="colorIds"
                                   id="color_@(color.Id)"
                                   @if (Model.SelectedColors != null) { @(Model.SelectedColors.Any(i => i.Id == color.Id) ? "checked" : "") ; } />
                            <label class="form-check-label" for="color_@(color.Id)">
                                @color.Name
                                <i class="fa fa-circle" style="color:@color.Code"></i>
                            </label>
                        </div>
                    }
                </div>
                <hr />
                <div class="form-check form-check-inline">
                    <input type="checkbox" class="form-check-input" asp-for="Product.IsHome" />
                    <label class="form-check-label" asp-for="Product.IsHome">Satışa Çıkarılsın mı ?</label>
                    <span class="text-danger" asp-validation-for="Product.IsHome"></span>
                </div>
                <br />
                @*Submit Button*@
                <button type="submit" id="btnSubmit" class="btn btn-primary btn-block">Kaydet</button>

            </div>
        </div>
        <div class="col-md-12">
            <div class="card p-2">
                <div class="form-group">
                    <p>Ana Resim</p>
                    <input type="file" name="mainImage" onchange="showpreview(this);" />
                    <input type="hidden" asp-for="Product.MainImage" />
                    @if (Model.Product.MainImage == "")
                    {
                        <img id="imgpreview" height="200" width="200" style="border-width: 0px;display: none;" />
                    }
                    else
                    {
                        <img src="~/img/@Model.Product.MainImage" id="imgpreview" height="200" width="200" style="border-width: 0px;" />
                    }
                    <span class="text-danger" asp-validation-for="Product.MainImage"></span>
                </div>
                <div class="form-group">
                    <p>Ürün Resimleri</p>
                    <input type="file" name="allImages" multiple onchange="previewFiles();" id="browse" />
                    <div id="preview">
                        @if (Model.Images != null)
                        {
                            @foreach (var image in Model.Images)
                            {
                                <img src="~/img/@image.ImagePath" id="img" height="200" width="200" style="border-width: 0px;" />
                            }
                        }

                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
<button class="btn btn-danger" onclick="test();">test</button>
@section Scripts{
    <script src="~/node_modules/trumbowyg/dist/trumbowyg.min.js"></script>
    <script src="~/node_modules/trumbowyg/dist/langs/tr.min.js"></script>
    @*@{await Html.RenderPartialAsync("_ValidationScriptsPartial");}*@

    <script>
        // \/Admin\/Product\/Add Regex for add url
        // \/Admin\/Product\/Edit\/\b[0-9a-f]{8}\b-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-\b[0-9a-f]{12}\b Regex for Edit Url
        // şuan guid kullanma
        $('#html-editor').trumbowyg({
            lang: 'tr'
        });

        $('#productForm').on('submit', function (event) {

            const addUrlRegex = new RegExp('\/Admin\/Product\/Add');
            const editUrlRegex = new RegExp('\/Admin\/Product\/Edit\/');
            const editUrlRegex2 = new RegExp('\/Admin\/Product\/Edit\/[a-z]*|[0-9]*');
            var url = "@Context.Request.Path";

            console.log(addUrlRegex.test(url));
            console.log(editUrlRegex.test(url));
            console.log(editUrlRegex2.test(url));

            var actionUrl = "";
            if (addUrlRegex.test(url)) {
                actionUrl = url;
            } else if (editUrlRegex.test(url) || editUrlRegex2(url)) {
                actionUrl = url;
            }
            var form_data = new FormData($('#productForm')[0]);
            console.log(actionUrl);
            $.ajax({
                type: 'POST',
                url: actionUrl,
                data: form_data,
                contentType: false,
                processData: false,
                success: function (res) {
                    if (res.isValid) {
                        toastr.success(res.message)
                    }
                    else
                        toastr.error(res.message);
                },
                error: function (err) {
                    console.log(err)
                }
            });
            //to prevent default form submit event
            //event.preventDefault();
            return false;
        });
        // TODO kategori silerken kategoriürün tablosundaki o kategorinin bulunduğu tüm verileri sil
        function showpreview(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#imgpreview').css('display', 'block');
                    $('#imgpreview').attr('src', e.target.result);
                    $('#imgpreview').fadeIn(650);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        function previewFiles() {
            var preview = document.querySelector('#preview');
            var files = document.querySelector('#browse').files;
            preview.innerHTML = "";
            function readAndPreview(file) {
                // Make sure `file.name` matches our extensions criteria
                if (/\.(jpe?g|png|gif)$/i.test(file.name)) {
                    var reader = new FileReader();
                    reader.addEventListener("load", function () {
                        var image = new Image();
                        image.height = 100;
                        image.title = file.name;
                        image.src = this.result;
                        preview.appendChild(image);
                    }, false);
                    reader.readAsDataURL(file);
                }
            }
            if (files) {
                [].forEach.call(files, readAndPreview);
            }
        }
    </script>
}
